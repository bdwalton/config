#!/bin/bash

BASE_PATH="$(realpath $(dirname $0)/../)"
SYSTEMD_BASE="${BASE_PATH}/systemd-user"
SYSTEMD_DIR="${HOME}/.config/systemd/user"

cd "${BASE_PATH}"

[ -d "${SYSTEMD_DIR}" ] || mkdir -p "${SYSTEMD_DIR}"

SERVICES="$(
    cd ${SYSTEMD_BASE}
    ls
)"

for service in ${SERVICES}; do
    serv=$(basename ${service})
    ln -f "${SYSTEMD_BASE}/${serv}" "${SYSTEMD_DIR}/${serv}"
    systemctl enable --user ${serv}

done

# We have a local .config/systemd/ service file for emacs so we can
# easily bounce our daemon.
systemctl daemon-reload --user

sudo loginctl enable-linger $USER

sudo bash -c 'cat <<EOF > /etc/systemd/logind.conf.d/kill-user-processes.conf
# Set by bdwconfig
[Login]
KillUserProcesses=yes
EOF'
